{
  "variables": {
    "aws_access_key": "",
    "aws_secret_key": "",

    "allow_vagrant_pubkey": "true",

    "ssh_name": "wdadmin",
    "ssh_pass": "wdadminpass",
    "hostname": "packer-test"
  },
  "builders": [
  {
    "type": "amazon-ebs",
    "access_key": "{{user `aws_access_key`}}",
    "secret_key": "{{user `aws_secret_key`}}",
    "region": "us-east-1",
    "source_ami": "ami-de0d9eb7",
    "instance_type": "t1.micro",
    "ssh_username": "{{user `ssh_name`}}",
    "ami_name": "{{user `hostname`}} {{timestamp}}"
  },
  {
    "type": "virtualbox",
    "guest_os_type": "Ubuntu_64",

    "vboxmanage": [
        ["modifyvm", "{{.Name}}", "--vram", "32"]
    ],

    "disk_size" : 10000,

    "iso_url": "http://releases.ubuntu.com/precise/ubuntu-12.04.3-server-amd64.iso",
    "iso_checksum": "2cbe868812a871242cdcdd8f2fd6feb9",
    "iso_checksum_type": "md5",

    "http_directory" : ".",
    "http_port_min" : 9001,
    "http_port_max" : 9001,

    "ssh_username": "{{user `ssh_name`}}",
    "ssh_password": "{{user `ssh_pass`}}",
    "ssh_wait_timeout": "20m",

    "shutdown_command": "echo {{user `ssh_pass`}} | sudo -S shutdown -P now",

    "boot_command" : [
        "<esc><esc><enter><wait>",
        "/install/vmlinuz noapic ",
        "preseed/url=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ubuntu_preseed.cfg ",
        "debian-installer=en_US auto locale=en_US kbd-chooser/method=us ",
        "hostname={{user `hostname`}} ",
        "fb=false debconf/frontend=noninteractive ",
        "keyboard-configuration/modelcode=SKIP keyboard-configuration/layout=USA ",
        "keyboard-configuration/variant=USA console-setup/ask_detect=false ",
        "initrd=/install/initrd.gz -- <enter>"
    ]
  }],

  "provisioners": [
    {
      "type": "file",
      "source": "./ssh_keys",
      "destination": "/tmp"
    },
    {
      "type": "shell",
      "scripts": [
        "provisioning/base.sh",
        "provisioning/provision_appserver.sh", 
        "provisioning/provision_proxyserver.sh",
        "provisioning/provision_dbserver.sh"
      ],
      "environment_vars": [
        "ALLOW_VAGRANT_PUBKEY={{user `allow_vagrant_pubkey`}}"
      ],
      "override": {
        "virtualbox": {
          "execute_command": "echo {{user `ssh_pass`}} | {{ .Vars }} sudo -E -S sh '{{.Path}}'"
        }
      }
    }
  ],

  "post-processors": ["vagrant"]
}