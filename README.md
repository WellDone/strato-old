# WellDone Strato Data Portal

Demo site available at http://strato.welldone.org.  It may be slightly out of date.

This portal is designed to complement WellDone's Mobile Monitor ([MoMo](http://www.github.com/welldone/MoMo-Firmware)) hardware sensor platform.

# Development and Deployment

To spin up a test application deployment using [Packer](http://www.packer.io) and [Vagrant](http://www.vagrantup.com):
* Build a base box by running `build.sh -v virtualbox` from the 'packer' directory NOTE: This will install the insecure Vagrant public key, so don't use it for anything sensitive.
* Run `vagrant up`
* Profit - the server should be accessible at http://localhost:3000

To deploy a production or test box to a public cloud ([AWS](http://aws.amazon.com/) or [DigitalOcean](https://digitalocean.com/)):
* Build a base box by running `build.sh <provider>` from the 'packer' directory, <provider> may be digitalocean or amazon-ebs (untested)
* Using the image generated by packer, spin up a new cloud VM
* Run `deploy.sh -p user@123.456.789.101` (where 'user' is a user with sudo priveleges on the cloud machine located at 123.456.789.101) from the root repo directory.  You must have established implicit ssh trust (using ssh identity keys) with the user on the remote machine.
** If you want to also seed the database with dummy data, run with -ps instead of just -p

## Configuration (on the application machine)

The following environment variable are available for configuration.  Edit and use startServer.sh to modify them for your own development environment, but the launcher file shouldn't be checked in.

```
export NODE_DEBUG_MODE = 1
export DATABASE_URL    = tcp://user:password@server:5432/Database
export WD_LOG_PATH     = /full/path/to/log/file
export TWILIO_ACCOUNT_SID={your account SID}
export TWILIO_AUTH_TOKEN={your auth token}
export TWILIO_NUMBER=+15555555555
```

## Database Migration

To create or upgrade the database, simply run the following command.  Before attempting the migration, make sure your DATABASE_URL environment variable is set up properly.

```
node db/migrate.js
```

A migration log is stored at db/debug.log.
The schema is kept at db/schema.js and migration steps will (eventually) be stored in db/migrations.

To clear all data from the main tables, use AT YOUR OWN RISK:

```
node db/seed.js --clean
```

Then, to seed the database do the following (see db/data/test.seed for an example and the default seedFile):

```
node db/seed.js [seedFile]
```
